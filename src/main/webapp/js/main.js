"use strict";var jsGen=angular.module("jsGen",["ngLocale","ngRoute","ngAnimate","ngResource","ngCookies","ui.validate","angularFileUpload"]);jsGen.config(["$httpProvider",function(e){e.defaults.headers.put["Content-Type"]="application/x-www-form-urlencoded",e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",e.defaults.transformRequest=[function(e){var t=function(e){var n,i,o,r,a,l,c,s="";for(n in e)if(i=e[n],i instanceof Array)for(c=0;c<i.length;++c)a=i[c],o=n+"["+c+"]",l={},l[o]=a,s+=t(l)+"&";else if(i instanceof Object)for(r in i)a=i[r],o=n+"."+r,l={},l[o]=a,s+=t(l)+"&";else void 0!==i&&null!==i&&(s+=encodeURIComponent(n)+"="+encodeURIComponent(i)+"&");return s.length?s.substr(0,s.length-1):s};return angular.isObject(e)&&"[object File]"!==String(e)?t(e):e}]}]),jsGen.config(["$httpProvider","app",function(e,t){var n=0,i=!1,o={count:0,total:0};o.cancel=function(){n=0,i=!1,this.count=0,this.total=0,t.loading(!1,this)},e.defaults.transformRequest.push(function(e){return n+=1,o.count=n,o.total+=1,i||window.setTimeout(function(){!i&&n>0&&(i=!0,t.loading(!0,o))},1e3),e}),e.defaults.transformResponse.push(function(e){return n-=1,o.count=n,i&&0===n&&o.cancel(),e}),e.interceptors.push(function(){return{response:function(e){var n,i=e.data;return angular.isObject(i)&&(t.timestamp=i.timestamp,n=!i.ack&&i.error),n?(t.toast.error(n.message,n.name),t.q.reject(i)):e},responseError:function(e){var n=e.data||e,i=e.status||"",o=n.message||(angular.isObject(n)?"Error!":n);return t.toast.error(o,i),t.q.reject(n)}}})}]).run(["app","$q","$rootScope","$location","$timeout","$filter","getFile","JSONKit","toast","timing","cache","restAPI","sanitize","CryptoJS","promiseGet","myConf","anchorScroll","isVisible","applyFn","param","store","i18n-zh",function(e,t,n,i,o,r,a,l,c,s,u,d,p,f,m,g,h,v,w,S,T,I){function y(){var e=L.viewWidth=E.width();L.viewHeight=E.height(),L.isPocket=480>e,L.isPhone=768>e,L.isTablet=!L.isPhone&&980>e,L.isDesktop=e>=980}function k(){d.index.get({},function(t){e.timeOffset=Date.now()-t.timestamp,t=t.data,t.title2=t.description,e.union(L,t),e.version="",e.upyun="",e.checkUser()})}var P={stopUnload:!1,nextUrl:""},L=n.global={isAdmin:!1,isEditor:!1,isLogin:!1,info:{}},E=$(window);e.q=t,e.store=T,e.toast=c,e.param=S,e.timing=s,e.location=i,e.timeout=o,e.timeOffset=0,e.timestamp=Date.now(),e.filter=r,e.locale=I,e.anchorScroll=h,e.isVisible=v,e.getFile=a,e.cache=u,e.restAPI=d,e.sanitize=p,e.CryptoJS=f,e.promiseGet=m,e.myConf=g,e.rootScope=n,angular.extend(e,l),e.loading=function(e,t){n.loading.show=e,w()},e.validate=function(t,n){var i=[],o=[];return t.$broadcast("genTooltipValidate",i,n),e.each(i,function(e){e.validate&&e.$invalid&&o.push(e)}),0===o.length?(e.validate.errorList=null,t.$broadcast("genTooltipValidate",i,!0)):e.validate.errorList=o,!e.validate.errorList},e.checkDirty=function(t,n,i){var o=e.union(t);return o&&n&&i?(e.intersect(o,i),e.each(o,function(e,t,i){angular.equals(e,n[t])&&delete i[t]}),e.removeItem(o,void 0),P.stopUnload=!e.isEmpty(o)):P.stopUnload=!1,P.stopUnload?o:null},e.checkUser=function(){L.isLogin=!!L.user,L.isAdmin=L.user&&5===L.user.role,L.isEditor=L.user&&L.user.role>=4,L.canPublish=L.isLogin&&L.user.role>=2},e.clearUser=function(){L.user=null,e.checkUser()},e.checkFollow=function(t){var n=L.user||{};t&&(t.isMe=t._id===n._id,t.isFollow=!t.isMe&&!!e.findItem(n.followList,function(e){return e===t._id}))},n.loading={show:!1},n.validateTooltip={validate:!0,validateMsg:I.VALIDATE},n.unSaveModal={confirmBtn:I.BTN_TEXT.confirm,confirmFn:function(){return P.stopUnload&&P.nextUrl&&(P.stopUnload=!1,o(function(){window.location.href=P.nextUrl},100)),!0},cancelBtn:I.BTN_TEXT.cancel,cancelFn:!0},n.$on("$viewContentLoaded",function(t){L.curl=e.location.path()}),n.$on("$locationChangeStart",function(e,t,i){P.stopUnload?(e.preventDefault(),P.nextUrl=t,n.unSaveModal.modal(!0)):P.nextUrl=""}),n.goBack=function(){window.history.go(-1)},n.logout=function(){d.user.get({ID:"logout"},function(){L.user=null,e.checkUser(),i.path("/")})},n.followMe=function(t){d.user.save({ID:t._id},{follow:!t.isFollow},function(n){n.follow?(L.user.followList.push(t._id),e.toast.success(I.USER.followed+t.name,I.RESPONSE.success)):e.findItem(L.user.followList,function(n,i,o){return n===t._id?(o.splice(i,1),e.toast.success(I.USER.unfollowed+t.name,I.RESPONSE.success),!0):void 0}),t.fans+=t.isFollow?-1:1,t.isFollow=!t.isFollow})},E.resize(w.bind(null,y)),s(function(){Date.now()-e.timestamp-e.timeOffset>=24e4&&k()},12e4),y(),k()}]),jsGen.filter("placeholder",["JSONKit",function(e){return function(t){return e.toStr(t)||"-"}}]).filter("match",["$locale",function(e){return function(t,n){return e.FILTER[n]&&e.FILTER[n][t]||""}}]).filter("switch",["$locale",function(e){return function(t,n){return e.FILTER[n]&&e.FILTER[n][+!!t]||""}}]).filter("checkName",["JSONKit",function(e){return function(t){var n=/[(\u4e00-\u9fa5)a-zA-Z0-9_]{1,}$/;return t=e.toStr(t),n.test(t)}}]).filter("length",["utf8","JSONKit",function(e,t){return function(n){return n=t.toStr(n),e.stringToBytes(n).length}}]).filter("cutText",["utf8","JSONKit",function(e,t){return function(n,i){n=t.toStr(n).trim();var o=e.stringToBytes(n);return i=i>0?i:0,o.length>i&&(o.length=i,n=e.bytesToString(o),n=n.slice(0,-2)+"…"),n}}]).filter("formatDate",["$filter","$locale",function(e,t){return function(n,i){var o=Date.now()-n,r=e("date");return i?r(n,t.DATETIME.fullD):o>2592e5?r(n,t.DATETIME.shortD):o>864e5?Math.floor(o/864e5)+t.DATETIME.dayAgo:o>36e5?Math.floor(o/36e5)+t.DATETIME.hourAgo:o>6e4?Math.floor(o/6e4)+t.DATETIME.minuteAgo:t.DATETIME.secondAgo}}]).filter("formatTime",["$locale",function(e){return function(t){function n(e){return o=r%e,r=(r-o)/e}var i="",o=0,r=t>0?Math.round(+t):Math.floor(Date.now()/1e3),a=e.DATETIME;return n(60),i=o+a.second,n(60),i=(o>0?o+a.minute:"")+i,n(24),i=(o>0?o+a.hour:"")+i,r>0?r+a.day+i:i}}]).filter("formatBytes",["$locale",function(e){return function(e){return e=e>0?e:0,e?1024>e?e+"B":1048576>e?(e/1024).toFixed(3)+" KiB":1073741824>e?(e/1048576).toFixed(3)+" MiB":(e/1073741824).toFixed(3)+" GiB":"-"}}]),jsGen.constant("app",{version:Date.now()}).provider("getFile",["app",function(e){this.html=function(t){return"/tpl/"+t+"?v="+e.version},this.md=function(t){return"/md/"+t+"?v="+e.version},this.$get=function(){return{html:this.html,md:this.md}}}]).config(["$routeProvider","$locationProvider","getFileProvider",function(e,t,n){var i={templateUrl:n.html("index.html"),controller:"indexCtrl"},o={templateUrl:n.html("login.html"),controller:"userLoginCtrl"},r={templateUrl:n.html("register.html"),controller:"userRegisterCtrl"},a={templateUrl:n.html("user.html"),controller:"homeCtrl"},l={templateUrl:n.html("admin.html"),controller:"adminCtrl"},c={templateUrl:n.html("article-editor.html"),controller:"articleEditorCtrl"},s=({templateUrl:n.html("survery-editor.html"),controller:"surveryEditorCtrl"},{templateUrl:n.html("index.html"),controller:"tagCtrl"}),u={templateUrl:n.html("reset.html"),controller:"userResetCtrl"},d={templateUrl:n.html("user.html"),controller:"userCtrl"},p={templateUrl:n.html("article.html"),controller:"articleCtrl"},f={templateUrl:n.html("collection.html"),controller:"collectionCtrl"};e.when("/hots",i).when("/update",i).when("/latest",i).when("/T:ID",i).when("/tag/:TAG",i).when("/login",o).when("/register",r).when("/reset",u).when("/home",a).when("/home/:OP",a).when("/admin",l).when("/admin/:OP",l).when("/tag",s).when("/add",c).when("/A:ID/edit",c).when("/user/U:ID",d).when("/user/U:ID/:OP",d).when("/U:ID",d).when("/U:ID/:OP",d).when("/A:ID",p).when("/C:ID",f).when("/",i).otherwise({redirectTo:"/"}),t.html5Mode(!0).hashPrefix("!")}]),jsGen.factory("restAPI",["$resource",function(e){return{index:e("/api/index/:OP"),user:e("/api/user/:ID/:OP"),article:e("/api/article/:ID/:OP"),tag:e("/api/tag/:ID/:OP"),friendLink:e("/api/friendLink/:ID/:OP"),skin:e("/api/skin/:ID/:OP")}}]).factory("cache",["$cacheFactory",function(e){return{user:e("user",{capacity:20}),article:e("article",{capacity:100}),comment:e("comment",{capacity:500}),list:e("list",{capacity:100})}}]).factory("myConf",["$cookieStore","JSONKit",function(e,t){function n(e,t){return null==e?t:e}function i(i,o){return function(r,a,l){a=t.toStr(a)+i,l=n(l,o);var c=n(e.get(a),l);return null!=r&&c!==n(r,l)&&(e.put(a,r),c=r),c}}return{pageSize:i("PageSize",10),sumModel:i("sumModel",!1)}}]).factory("anchorScroll",function(){function e(e,n,i){var o=$(window).height();e=$(e),i=i>0?i:o/10,$("html, body").animate({scrollTop:n?e.offset().top-i:e.offset().top+e.outerHeight()+i-o},{duration:200,easing:"linear",complete:function(){t(e)||e[0].scrollIntoView(!!n)}})}function t(e){function t(e){return e>a&&l>e}e=$(e);var n=$(window),i=n.height(),o=e.offset().top,r=e.outerHeight(),a=n.scrollTop(),l=a+i;return t(o+(r>i?i:r)/2)?!0:r>i?t(o+r-i/2):!1}return{toView:e,inView:t}}).factory("isVisible",function(){return function(e){var t=e[0].getBoundingClientRect();return Boolean(t.bottom-t.top)}}).factory("applyFn",["$rootScope",function(e){return function(t,n){t=angular.isFunction(t)?t:angular.noop,n=n&&n.$apply?n:e,t(),n.$$phase||n.$apply()}}]).factory("timing",["$rootScope","$q","$exceptionHandler",function(e,t,n){function i(i,o,r){var a,l=0,c=t.defer(),s=c.promise;return i=angular.isFunction(i)?i:angular.noop,o=parseInt(o,10),r=parseInt(r,10),r=r>=0?r:0,a=window.setInterval(function(){if(l+=1,r&&l>=r)window.clearInterval(a),c.resolve(i(l,r,o));else try{i(l,r,o)}catch(t){c.reject(t),n(t)}e.$$phase||e.$apply()},o),s.$timingId=a,s}return i.cancel=function(e){return e&&e.$timingId?(clearInterval(e.$timingId),!0):!1},i}]).factory("promiseGet",["$q",function(e){return function(t,n,i,o){var r,a=e.defer();return r=i&&o&&o.get(i),r?a.resolve(r):n.get(t,function(e){i&&o&&o.put(i,e),a.resolve(e)},function(e){a.reject(e.error)}),a.promise}}]).factory("getList",["restAPI","cache","promiseGet",function(e,t,n){return function(i){return n({ID:i,s:10},e.article,i,t.list)}}]).factory("getArticle",["restAPI","cache","promiseGet",function(e,t,n){return function(i){return n({ID:i},e.article,i,t.article)}}]).factory("getUser",["restAPI","cache","promiseGet",function(e,t,n){return function(i){return n({ID:i},e.user,i,t.user)}}]).factory("getMarkdown",["$http",function(e){return function(){return e.get("/md/markdown.md",{cache:!0})}}]).factory("toast",["$log","JSONKit",function(e,t){var n={},i=["info","error","success","warning"];return angular.forEach(i,function(i){n[i]=function(n,o){var r=e[i]||e.log;o=t.toStr(o),r(n,o),n=angular.isObject(n)?angular.toJson(n):t.toStr(n),toastr[i](n,o)}}),toastr.options=angular.extend({positionClass:"toast-bottom-full-width"},n.options),n.clear=toastr.clear,n}]).factory("param",function(){return $.param}).factory("CryptoJS",function(){return window.CryptoJS}).factory("utf8",function(){return window.utf8}).factory("store",function(){return window.store}).factory("JSONKit",function(){return window.JSONKit}).factory("editormd",["$q",function(e){var t=window.editormd;if(t){var n={};angular.forEach(["loadScript","loadCSS"],function(i){var o=t[i];t[i]=function(t,r,a){var l=i+"_"+t,c=n[l];c||(c=n[l]=e.defer(),o.call(this,t,c.resolve,a)),c.promise.then(r||angular.noop)}})}return t}]).factory("sanitize",["JSONKit",function(e){var t=Sanitize,n=t.Config,i=[new t({}),new t(n.RESTRICTED),new t(n.BASIC),new t(n.RELAXED)];return function(t,n){var o=document.createElement("div"),r=document.createElement("div");return n=n>=0?n:3,o.innerHTML=e.toStr(t),r.appendChild(i[n].clean_node(o)),r.innerHTML}}]),jsGen.directive("genParseMd",["isVisible","$timeout","$q","editormd",function(e,t,n,i){var o=function(){var e=n.defer();return i.prototype.loadQueues.call({settings:{path:"/md-lib/",flowChart:!0,sequenceDiagram:!0,searchReplace:!0,readOnly:!0,codeFold:!0,previewCodeHighlight:!0,mode:"markdown"},setToolbar:function(){},setCodeMirror:function(){},loadedDisplay:e.resolve}),e.promise}(),r=function(e,t){return o.then(function(){return i.markdownToHTML(e,{markdown:t,htmlDecode:"style,script,iframe",tocm:!0,emoji:!0,taskList:!0,tex:!0,flowChart:!0,sequenceDiagram:!0})})},a=0;return function(n,i,o){function l(e){angular.isDefined(e)&&r(i.attr("id"),e)}i.attr("id")||i.attr("id","md-preview-"+ ++a),n.$watch(o.genParseMd,function(n){e(i)?l(n):t(function(){l(n)},500)})}}]).directive("genTabClick",function(){return{link:function(e,t,n){var i=n.genTabClick;t.bind("click",function(){t.parent().children().removeClass(i),t.addClass(i)})}}}).directive("genPagination",["getFile",function(e){return{scope:!0,templateUrl:e.html("gen-pagination.html"),link:function(e,t,n){e.$watchCollection(n.genPagination,function(t){if(angular.isObject(t)){var n=1,i=[],o=Math.ceil(t.total/t.pageSize)||1;if(n=t.pageIndex>=1?t.pageIndex:1,n=o>=n?n:o,i[0]=n,6>=n)for(;i[0]>1;)i.unshift(i[0]-1);else i.unshift(i[0]-1),i.unshift(i[0]-1),i.unshift("…"),i.unshift(2),i.unshift(1);if(5>=o-n)for(;i[i.length-1]<o;)i.push(i[i.length-1]+1);else i.push(i[i.length-1]+1),i.push(i[i.length-1]+1),i.push("…"),i.push(o-1),i.push(o);e.prev=n>1?n-1:0,e.next=o>n?n+1:0,e.total=t.total,e.pageIndex=n,e.showPages=i,e.pageSize=t.pageSize,e.perPages=t.sizePerPage||[10,20,50],e.path=t.path&&t.path+"?p="}}),e.paginationTo=function(t,n){!e.path&&t>0&&(n=n||e.pageSize,e.$emit("genPagination",t,n))}}}}]).directive("genModal",["getFile","$timeout",function(e,t){var n=0;return{scope:!0,transclude:!0,templateUrl:e.html("gen-modal.html"),link:function(e,i,o){function r(e){return function(){var t=p(e)?e():!0;l(!t)}}function a(){var e=$(window),t=s.children(),n=.382*(e.height()-t.outerHeight()),i={};i.marginTop=n>0?n:0,t.css(i)}function l(e){s.modal(e?"show":"hide"),e&&t(a)}var c,s=i.children(),u=["Confirm","Cancel","Delete"],d=e.$eval(o.genModal),p=angular.isFunction;d.cancelFn=d.cancelFn||!0,d.backdrop=d.backdrop||!0,d.show=d.show||!1,d.remote=d.remote||!1,d.modal=l,e.$watch(function(){return d},function(t){angular.extend(e,t)},!0),e.id=e.id||o.genModal+"-"+n++,angular.forEach(u,function(t){var n=t.toLowerCase(),i=n+"Cb",o=n+"Fn",a=n+"Btn";e[i]=d[o]&&r(d[o]),e[a]=d[a]||d[o]&&t}),s.on("shown.bs.modal",function(e){c=!0}),s.on("hidden.bs.modal",function(e){c&&p(d.cancelFn)&&d.cancelFn(),c=!1}),s.modal(d)}}}]).directive("genTooltip",["$timeout","isVisible",function(e,t){return{require:"?ngModel",link:function(n,i,o,r){function a(e){if(r.validate=u&&d.validate&&t(i),r.validate){var n=r.$name&&r.$name+" "||"";e&&d.validateMsg&&angular.forEach(r.$error,function(e,t){n+=e&&d.validateMsg[t]&&d.validateMsg[t]+", "||""}),n=n.slice(0,-2)||o.originalTitle||o.title,o.$set("dataOriginalTitle",n?n:""),s(!!e)}else s(!1)}function l(t){return e(function(){a(r.$invalid)}),t}function c(){i.off(".tooltip").removeData("bs.tooltip"),i.tooltip(d)}function s(e){i.hasClass("invalid-error")!==e&&(i[e?"addClass":"removeClass"]("invalid-error"),i.tooltip(e?"show":"hide"))}var u=!1,d=n.$eval(o.genTooltip)||{};"inner"===d.container?d.container=i:"ngView"===d.container&&(d.container=i.parents(".ng-view")[0]||i.parents("[ng-view]")[0]),d.validate?(d.template='<div class="tooltip validate-tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',d.trigger="manual",d.placement=d.placement||"right",r?(r.$formatters.push(l),r.$parsers.push(l)):n.$watch(function(){return o.originalTitle||o.dataOriginalTitle},s),i.bind("focus",function(){i.trigger("input"),i.trigger("change")}),n.$on("genTooltipValidate",function(e,t,n){u=!n,r&&(angular.isArray(t)&&t.push(r),a(r.$invalid))})):d.click&&i.bind("click",function(){i.tooltip(d.click)}),i.bind("hidden.bs.tooltip",c),c()}}}]).directive("genMoving",["anchorScroll",function(e){return{link:function(t,n,i){function o(){var e=n.find("textarea");e.is(e)&&e.css({height:"auto",width:"100%"})}var r=t.$eval(i.genMoving);r.appendTo=function(e){n.appendTo($(e)),o()},r.prependTo=function(e){n.prependTo($(e)),o()},r.childrenOf=function(e){return $(e).find(n).is(n)},r.scrollIntoView=function(t,i){e.toView(n,t,i)},r.inView=function(){return e.inView(n)}}}}]).directive("genSrc",["isVisible",function(e){return{priority:99,link:function(e,t,n){n.$observe("genSrc",function(e){if(e){var t=new Image;t.onload=function(){n.$set("src",e)},t.src=e}})}}}]).directive("genUploader",["getFile","FileUploader","app",function(e,t,n){return{priority:99,scope:!0,tansclude:!0,templateUrl:e.html("gen-uploader.html"),controller:["$scope","$element","$attrs",function(e,i,o){var r=e,a=i,l=o,c=r.$eval(l.genUploader);r.triggerUpload=function(){setTimeout(function(){a.find(".upload-input").click()})},r.clickImage=c.clickImage||angular.noop;var s=r.uploaded=[],u=r.uploader=new t({scope:c.scope||r,url:c.url});u.filters.push({name:"imageFilter",fn:function(e,t){var i="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|",o=-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(i);return o||n.toast.warning(n.locale.UPLOAD.fileType),o}}),u.onCompleteItem=function(e,t,i,o){var r=n.union(e.file,t);r&&r.url&&(r.url=c.baseUrl+r.url,s.push(r))},u.onErrorItem=function(e,t,i,o){n.toast.warning(t.message,t.code)}}]}}]).directive("genEditor",["$q","editormd",function(e,t){var n={article:{height:"450px",watch:!0,toolbarIcons:function(){return["undo","redo","|","bold","del","italic","quote","uppercase","lowercase","|","h1","h2","h3","h4","h5","h6","|","list-ul","list-ol","hr","|","watch","fullscreen","|","help"]}},comment:{height:"300px",watch:!1,toolbarIcons:function(){return["bold","del","italic","quote","uppercase","lowercase","|","h1","h2","h3","h4","h5","h6","|","list-ul","list-ol","hr","|","watch","fullscreen","|","help"]}}},i=0;return{require:"?ngModel",restrict:"A",link:function(o,r,a,l){r.attr("id")||r.attr("id","md-input-"+ ++i);var c=e.defer(),s=t(r.attr("id"),angular.extend({path:"/md-lib/",markdown:l.$viewValue||"",delay:0,width:"100%",placeholder:a.placeholder||"",autoFocus:!1,emoji:!0,taskList:!0,codeFold:!0,tocm:!0,tex:!0,flowChart:!0,sequenceDiagram:!0,onload:function(){s.cm.on("change",function(){var e=s.getMarkdown();l.$viewValue!=e&&l.$setViewValue(e)}),c.resolve()}},n[a.genEditor||"article"]));o.$watch(a.ngModel,function(e,t){c.promise.then(function(){var t=s.getMarkdown();e!=t&&s.setMarkdown(e)})})}}}]),jsGen.factory("i18n-zh",["$locale",function(e){return angular.extend(e,{RESET:{locked:"申请解锁",passwd:"找回密码",email:"请求信息已发送到您的邮箱，请查收。"},RESPONSE:{success:"请求成功",error:"请求失败"},VALIDATE:{required:"必填！",minlength:"太短！",maxlength:"太长！",min:"太小！",max:"太大！",more:"太多！",email:"Email无效！",pattern:"格式无效！",username:"有效字符为汉字、字母、数字、下划线，以汉字或小写字母开头！",minname:"长度应大于5字节，一个汉字3字节！",maxname:"长度应小于15字节，一个汉字3字节！",repasswd:"密码不一致！",url:"URL无效！",tag:"标签错误，不能包含“,”、“，”和“、”"},BTN_TEXT:{confirm:"确定",cancel:"取消",remove:"删除",goBack:"返回"},TIMING:{goHome:"秒钟后自动返回主页"},HOME:{title:"我的主页",index:" 更新，最近阅读：",mark:"我的收藏",article:"我的文章",comment:"我的评论",follow:"我的关注",fans:"我的粉丝"},ADMIN:{index:"网站信息",user:"用户管理",tag:"标签管理",article:"文章管理",comment:"评论管理",message:"消息管理",global:"网站设置",updated:"成功更新 ",noUpdate:"设置暂无变更"},ARTICLE:{title:"添加/编辑文章",preview:"预览：",reply:"评论：",removed:"成功删除 ",updated:"成功更新 ",noUpdate:"文章暂无变更",added:"成功保存 ",markdown:"Markdown简明语法",marked:"已收藏 ",unmarked:"已取消收藏 ",favored:"已支持 ",unfavored:"已取消支持 ",opposed:"已反对 ",unopposed:"已取消反对 ",highlight:"置顶 ",unhighlight:"取消置顶 "},USER:{title:"的主页",login:"用户登录",reset:"用户信息找回",register:"用户注册",article:"的文章",fans:"的粉丝",followed:"已关注 ",unfollowed:"已取消关注 ",email:"验证邮件已发送到新邮箱，通过验证后才保存修改",updated:"用户信息更新成功",noUpdate:"用户信息暂无变更",noLogin:"您还未登录",gag:"您已被禁言"},TAG:{title:"热门标签",removed:"成功删除 ",updated:"成功更新 ",noUpdate:"标签暂无变更"},FILTER:{role:["禁言","待验证","会员","组员","编辑","管理员"],follow:["关注","已关注"],favor:["支持","已支持"],mark:["收藏","已收藏"],oppose:["反对","已反对"],highlight:["置顶","取消置顶"],turn:["开启","关闭"],edit:["添加","编辑"],gender:{male:"男",female:"女"}},DATETIME:{second:"秒",minute:"分",hour:"时",day:"天",month:"月",year:"年",fullD:"yyyy年MM月dd日 HH:mm",shortD:"MM-dd HH:mm",dayAgo:"天前",hourAgo:"小时前",minuteAgo:"分钟前",secondAgo:"刚刚"},UPLOAD:{fileType:"文件类型无效，仅允许png、gif、jpg文件！"}}),e}]),jsGen.controller("adminArticleCtrl",["app","$scope",function(e,t){}]),jsGen.controller("adminCtrl",["app","$scope","$routeParams",function(e,t,n){function i(e){return e="comment"===e?"article":e,"admin-"+e+".html"}var o=e.rootScope.global,r=n.OP||"index";return o.isEditor?(t.parent={getTpl:e.getFile.html(i(r)),viewPath:r},void(o.title2=e.locale.ADMIN[r])):e.location.search({}).path("/")}]),jsGen.controller("adminFriendLinkCtrl",["app","$scope",function(e,t){function n(n){o=e.intersect(e.union(a),n),t.friendLinkList=e.union(o),t.parent.editSave=!!e.checkDirty(a,o,t.friendLinkList)}var i=e.restAPI.friendLink,o={},r=e.myConf,a=[{_id:"",name:"",imgUrl:"",url:"",orderBy:0,date:0,display:!1}];t.editFriendLink={},t.parent={editSave:!1,isSelectAll:!1};var l=function(){e.promiseGet({OP:"admin"},i).then(function(i){var o=i.pagination||{};o.path=e.location.path(),o.pageSize=r.pageSize(o.pageSize,"friendLinkAdmin"),o.sizePerPage=[20,100,200],t.pagination=o,n(i.data)})},c={show:function(){$("#frendlink-modal").modal("show")},hide:function(){$("#frendlink-modal").modal("hide")},cancel:function(){t.cancel()},init:function(){$("#frendlink-modal").on("shown.bs.modal",function(e){c.modalStatus=!0}),$("#frendlink-modal").on("hidden.bs.modal",function(e){c.modalStatus&&c.cancel(),c.modalStatus=!1})}};c.init(),t.selectAll=function(){e.each(t.friendLinkList,function(e){e.isSelect=t.parent.isSelectAll})},t.getfriendLinkModal=e.getFile.html("admin-friendLink-edit.html"),t.postAdd=function(){c.show()},t.postUpdate=function(){var n=e.findItem(t.friendLinkList,function(e,t){return e.isSelect});return n?(t.editFriendLink=e.union(n),void c.show()):void e.toast.error("请选择一个!")},t.toggleDisplay=function(e){e.display=!e.display,i.save({ID:e._id,OP:"display"},{display:e.display?1:0},function(t){t.ack||(e.display=!e.display)})},t.postDelete=function(){var n=[];if(e.each(t.friendLinkList,function(e,t){e.isSelect&&n.push(e)}),!n)return void e.toast.error("请至少选择一个!");var o=[];for(var r in n)o.push(n[r]._id);i.save({ID:"delete"},{fids:o.join(",")},function(e){l()})},t.cancel=function(){c.hide(),t.editFriendLink={}},t.save=function(){var n=e.union(t.editFriendLink),o=n._id;i.save({ID:o||"index",OP:o&&"edit"},n,function(n){o?e.each(t.friendLinkList,function(t,i){t._id==o&&e.union(t,n.data)}):t.friendLinkList.push(n.data)}),t.cancel(),t.editFriendLink={}},l()}]),jsGen.controller("adminGlobalCtrl",["app","$scope",function(e,t){function n(n){t.global=e.union(n),o=e.union(n),o=e.intersect(e.union(i),o),t.editGlobal=e.union(o),e.checkDirty(i,o,t.editGlobal)}var i,o={},r=e.locale,a=e.filter,l=e.restAPI.index;a("length");t.parent={switchTab:"tab1"},t.reset=function(){t.editGlobal=e.union(o)},t.submit=function(){var a=e.union(t.editGlobal);e.validate(t)&&(a=e.checkDirty(i,o,a),e.isEmpty(a)?e.toast.info(r.ADMIN.noUpdate):l.save({OP:"admin"},a,function(t){n(t.data);var i=e.union(o);e.union(e.rootScope.global,i),e.toast.success(r.ADMIN.updated,r.RESPONSE.success)}))},t.$watchCollection("editGlobal",function(t){t&&i&&e.checkDirty(i,o,t)}),e.promiseGet({OP:"admin"},l).then(function(t){i=e.union(t.data),n(t.data)})}]),jsGen.controller("adminTagCtrl",["app","$scope","$routeParams",function(e,t,n){function i(n){o=e.union(e.union(s),n),t.tagList=e.union(o),t.parent.editSave=!!e.checkDirty(s,o,t.tagList)}var o={},r=e.restAPI.tag,a=e.myConf,l=e.locale,c={ID:"index",p:n.p,s:n.s||a.pageSize(null,"tagAdmin",20)},s=[{_id:"",articles:0,tag:"",users:0}];t.parent={editSave:!1},t.pagination={},t.removeTag=null,t.removeTagModal={confirmBtn:l.BTN_TEXT.confirm,confirmFn:function(){var n=t.removeTag;return r.remove({ID:n._id},function(){e.findItem(t.tagList,function(t,i,o){return t._id===n._id?(o.splice(i,1),e.toast.success(l.TAG.removed+n.tag,l.RESPONSE.success),!0):void 0}),i(t.tagList),t.removeTag=null}),!0},cancelBtn:l.BTN_TEXT.cancel,cancelFn:function(){return t.removeTag=null,!0}},t.checkTag=function(t,n){var i=e.toStr(n.$value);return!/[,，、]/.test(i)},t.checkTagMin=function(t,n){return e.filter("length")(n.$value)>=3},t.reset=function(){t.tagList=e.union(o)},t.remove=function(e){t.removeTag=e,t.removeTagModal.modal(!0)},t.submit=function(){var n=[{_id:"",tag:""}];if(e.validate(t)){var a=e.checkDirty(s,o,t.tagList);e.isEmpty(a)?e.toast.info(l.TAG.noUpdate):(a=e.intersect(n,a),r.save({ID:"admin"},{data:a},function(n){var o=[];e.each(a,function(i){var o=n.data[i._id];o||e.findItem(t.tagList,function(e,t,n){return i._id===e._id?(n.splice(t,1),!0):void 0})}),e.each(n.data,function(n){e.findItem(t.tagList,function(t,i,r){return n._id===t._id?(e.union(t,n),o.push(n.tag),!0):void 0})}),i(t.tagList),e.toast.success(l.TAG.updated+o.join(", "),l.RESPONSE.success)}))}},t.$watch("tagList",function(n){t.parent.editSave=!!e.checkDirty(s,o,n)},!0),e.promiseGet(c,r).then(function(n){var o=n.pagination||{};o.path=e.location.path(),o.pageSize=a.pageSize(o.pageSize,"tagAdmin"),o.sizePerPage=[20,50,100],t.pagination=o,i(n.data)})}]),jsGen.controller("adminUserCtrl",["app","$scope","$routeParams",function(e,t,n){function i(n){o=e.intersect(e.union(s),n),t.userList=e.union(o),t.parent.editSave=!!e.checkDirty(s,o,t.userList)}var o={},r=e.restAPI.user,a=e.myConf,l=e.locale,c={ID:"admin",p:n.p,s:n.s||a.pageSize(null,"userAdmin",20)},s=[{_id:"",name:"",locked:!1,email:"",role:0,score:0,date:0,lastLoginDate:0}];t.parent={editSave:!1,isSelectAll:!1},t.pagination={},t.roleArray=[0,1,2,3,4,5],t.selectAll=function(){e.each(t.userList,function(e){e.isSelect=t.parent.isSelectAll})},t.reset=function(){t.userList=e.union(o)},t.submit=function(){var n=[{_id:"",locked:!1,role:0}];if(e.validate(t)){var a=e.checkDirty(s,o,t.userList);e.isEmpty(a)?e.toast.info(l.USER.noUpdate):(a=e.intersect(n,a),r.save({ID:"admin"},{data:a},function(n){var o=[];e.each(n.data,function(n){e.findItem(t.userList,function(t){return n._id===t._id?(e.union(t,n),o.push(n.name),!0):void 0})}),i(t.userList),e.toast.success(l.USER.updated+o.join(", "),l.RESPONSE.success)}))}},t.$watch("userList",function(n){t.parent.editSave=!!e.checkDirty(s,o,n)},!0),e.promiseGet(c,r).then(function(n){var o=n.pagination||{};o.path=e.location.path(),o.pageSize=a.pageSize(o.pageSize,"userAdmin"),o.sizePerPage=[20,100,200],t.pagination=o,i(n.data)})}]),jsGen.controller("articleCtrl",["app","$scope","$routeParams","getList","getMarkdown",function(e,t,n,i,o){function r(t){var n=S._id||"-";angular.isObject(t)&&(t.favorsList=t.favors?t.favors.split(","):[],t.opposesList=t.opposes?t.opposes.split(","):[],t.isAuthor=n===t.author._id,t.isMark=!!e.findItem(t.markList,function(e){return e._id===n}),t.isFavor=!!e.findItem(t.favorsList,function(e){return e===n}),t.isOppose=!!e.findItem(t.opposesList,function(e){return e===n}),t.commentsList&&e.each(t.commentsList,function(e){r(e)}))}function a(){return p.isLogin||e.toast.error(d.USER.noLogin),p.isLogin}function l(){return p.canPublish||e.toast.error(d.USER.gag),p.canPublish}function c(){var e=t.comment,n=t.article;e.replyToComment="",e.title="评论："+g(n.title,p.TitleMaxLen-9),e.content="",e.refer=n._id,t.replyMoving.prependTo("#comments")}var s="A"+n.ID,u=e.myConf,d=e.locale,p=e.rootScope.global,f=e.filter,m=f("length"),g=f("cutText"),h=e.cache.comment,v=e.cache.list,w=e.restAPI.article,S=p.user||{};S={_id:S._id,name:S.name,avatar:S.avatar},t.parent={wmdPreview:!1,contentBytes:0,markdownHelp:""},t.comment={title:"",content:"",refer:"",replyToComment:""},t.replyMoving={},t.commentMoving={},t.markdownModal={title:d.ARTICLE.markdown,cancelBtn:d.BTN_TEXT.goBack},t.validateTooltip=e.union(e.rootScope.validateTooltip),t.validateTooltip.placement="bottom",t.removeCommentModal={confirmBtn:d.BTN_TEXT.confirm,confirmFn:function(){var n=t.removeComment;return e.restAPI.article.remove({ID:n._id},function(){e.findItem(t.article.commentsList,function(i,o,r){return i._id===n._id?(r.splice(o,1),t.article.comments=r.length,e.toast.success(d.ARTICLE.removed+n.title,d.RESPONSE.success),!0):void 0}),t.removeComment=null}),!0},cancelBtn:d.BTN_TEXT.cancel,cancelFn:function(){return t.removeComment=null,!0}},t.remove=function(e){(e.isAuthor||p.isEditor)&&(t.removeComment=e,t.removeCommentModal.modal(!0))},t.wmdHelp=function(){o().success(function(e){t.parent.markdownHelp=e,t.markdownModal.modal(!0)})},t.wmdPreview=function(){t.parent.wmdPreview=!t.parent.wmdPreview,t.replyMoving.scrollIntoView(!0)},t.checkContentMin=function(e,n){var i=m(n.$value);return t.parent.contentBytes=i,i>=p.ContentMinLen},t.checkContentMax=function(e,t){return m(t.$value)<=p.ContentMaxLen},t.reply=function(n){var i=t.comment;i.refer=n._id,t.parent.wmdPreview=!1,n._id===t.article._id?c():(i.replyToComment=n._id,i.title=d.ARTICLE.reply+g(e.sanitize(n.content,0),p.TitleMaxLen-9),t.replyMoving.appendTo("#"+n._id)),t.replyMoving.scrollIntoView()},t.getComments2=function(n,i){i.commentsList?t.commentMoving.childrenOf("#"+i._id)?(t.referComments=null,t.commentMoving.appendTo("#comments")):(t.referComments=i.commentsList,t.commentMoving.appendTo("#"+i._id)):i.comments>0&&(t.referComments=[],w.save({ID:"comment"},{refer:n,replyToComment:i._id},function(n){e.each(n.data,function(e){r(e),h.put(e._id,e)}),i.commentsList=n.data,t.commentMoving.childrenOf("#"+i._id)?(t.commentMoving.appendTo("#comments"),t.referComments=null):(t.referComments=n.data,t.commentMoving.appendTo("#"+i._id))}))},t.highlight=function(e){e.status=2===e.status?0:2},t.zding=function(e){a()&&w.save({ID:e._id,OP:"zding"},{zding:!e.zding},function(){e.zding=!e.zding})},t.jing=function(e){a()&&w.save({ID:e._id,OP:"jing"},{jing:!e.jing},function(){e.jing=!e.jing})},t.setMark=function(e){},t.setFavor=function(t){a()&&w.save({ID:t._id,OP:"favor"},{favor:!t.isFavor},function(){t.isFavor=!t.isFavor,t.isFavor?(t.favorsList.push(S._id),e.removeItem(t.opposesList,S._id),t.isOppose=!1):e.removeItem(t.favorsList,S._id),e.toast.success(d.ARTICLE[t.isFavor?"favored":"unfavored"])})},t.setOppose=function(t){a()&&w.save({ID:t._id,OP:"oppose"},{oppose:!t.isOppose},function(){t.isOppose=!t.isOppose,t.isOppose?(t.opposesList.push(S._id),e.removeItem(t.favorsList,S._id),t.isFavor=!1):e.removeItem(t.opposesList,S._id),e.toast.success(d.ARTICLE[t.isOppose?"opposed":"unopposed"])})},t.submit=function(){if(a()&&l()&&e.validate(t)){var n=e.union(t.comment),i=t.article;w.save({ID:i._id,OP:"comment"},n,function(n){var o=n.data,r=t.comment.replyToComment;i.comments+=1,i.updateTime=Date.now(),o.favorsList=[],o.opposesList=[],r?e.findItem(i.commentsList,function(e,t,n){return r===e._id?(e.comments=e.comments||0,e.comments++,e.commentsList&&e.commentsList.push(o),!0):void 0}):i.commentsList.unshift(o),h.put(o._id,o),c()})}},t.$on("genPagination",function(n,i,o){n.stopPropagation();var a={ID:s,OP:"comment",p:i,s:u.pageSize(o,"comment",10)};e.promiseGet(a,w,e.param(a),v).then(function(n){var i=n.pagination||{},o=n.data;i.pageSize=u.pageSize(i.pageSize,"comment"),t.pagination=i,e.each(o,function(e){r(e),h.put(e._id,e)}),t.article.commentsList=o,e.anchorScroll.toView("#comments",!0)})}),e.promiseGet({ID:s},w,s,e.cache.article).then(function(n){var i=n.pagination||{},o=n.data;i.pageSize=u.pageSize(i.pageSize,"comments"),r(o),e.each(o.commentsList,function(e){h.put(e._id,e)}),p.title2=o.title,t.pagination=i,t.article=o,c(),e.promiseGet({ID:o.author._id,OP:"article"},e.restAPI.user,o.author._id,v).then(function(n){var i=n.user,o=t.article.author;e.checkFollow(i),o.articlesList=n.data})})}]),jsGen.controller("articleEditorCtrl",["app","$scope","$routeParams","getMarkdown",function(e,t,n,i){function o(n){h=e.union(g),n?(n=e.union(n),e.each(n.tagsList,function(e,t,n){n[t]=e.tag}),n.refer=n.refer&&n.refer.url,e.intersect(h,n),t.article=e.union(h),e.checkDirty(g,h,t.article)):(t.article={},e.each(g,function(n,i){t.article[i]=e.store.get("article."+i)||n})),r(n)}function r(e){var n=t.parent,o=t.article;e?(n.title=s.ARTICLE.preview+c(o.title),n.content=o.content):i().success(function(e){n.title=s.ARTICLE.markdown,n.content=e})}var a,l=n.ID&&"A"+n.ID,c=e.toStr,s=e.locale,u=e.rootScope.global,d=e.filter,p=(e.upyun,d("length")),f=(d("cutText"),e.restAPI.article),m=e.cache.article,g={
title:"",content:"",refer:"",tagsList:[]},h=e.union(g);if(!u.isLogin)return e.location.search({}).path("/");u.title2=e.locale.ARTICLE.title,t.parent={edit:!!l,wmdPreview:!0,contentBytes:0,titleBytes:0,title:"",content:""};var v=u.cloudDomian||u.url||window.location.origin;t.uploaderOptions={scope:t,allowFileType:"|jpg|png|jpeg|bmp|gif|",url:"/api/upload",baseUrl:v,clickImage:function(e){t.article.content=(t.article.content||"")+"\n!["+e.name+"]("+e.url+")\n"}},t.validateTooltip=e.union(e.rootScope.validateTooltip),t.validateTooltip.placement="bottom",t.store=function(n){var i=t.article[n];e.store.set("article."+n,i)},t.checkTitleMin=function(n,i){var o=p(i.$value);return t.parent.titleBytes=o,t.parent.wmdPreview&&(t.parent.title=s.ARTICLE.preview+e.sanitize(i.$value,0)),o>=u.TitleMinLen},t.checkTitleMax=function(e,t){return p(t.$value)<=u.TitleMaxLen},t.checkContentMin=function(e,n){var i=p(n.$value);return t.parent.contentBytes=i,t.parent.wmdPreview&&(t.parent.content=n.$value),i>=u.ContentMinLen},t.checkContentMax=function(e,t){return p(t.$value)<=u.ContentMaxLen},t.checkTag=function(e,t){var n=t.$value||"";return n=angular.isString(n)?n.split(/[,，、]/):n,n.length<=u.ArticleTagsMax},t.getTag=function(e){var n=t.article.tagsList;n.indexOf(e.tag)<0&&n.length<u.ArticleTagsMax&&(t.article.tagsList=n.concat(e.tag),t.store("tagsList"))},t.wmdPreview=function(){var e=t.parent;e.wmdPreview=!e.wmdPreview,r(e.wmdPreview)},t.submit=function(){var n=e.union(t.article);e.validate(t)&&(e.checkDirty(g,h,n)?(n.title=e.sanitize(n.title,0),f.save({ID:l||"index",OP:l&&"edit"},n,function(t){var n=t.data;a&&(delete n.commentsList,n=t.data=e.union(a.data,n)),m.put(n._id,t),o(n),e.toast.success(s.ARTICLE[l?"updated":"added"]+n.title);var i=e.timing(null,1e3,2);i.then(function(){e.location.search({}).path("/"+n._id)}),e.store.clear()})):e.toast.info(s.ARTICLE.noUpdate))},e.store.enabled||t.$watchCollection("article",function(t){e.checkDirty(g,h,t)}),l?(a=m.get(l),e.promiseGet({ID:l},f,l,m).then(function(e){o(e.data)})):o()}]),jsGen.controller("homeCtrl",["app","$scope","$routeParams",function(e,t,n){function i(e){switch(e){case"follow":case"fans":return"user-list.html";case"detail":return"user-edit.html";case"skin":return"user-skin.html";case"article":case"comment":case"mark":return"user-article.html";default:return"user-article.html"}}var o=e.rootScope.global;return o.isLogin?(o.title2=e.locale.HOME.title,t.user=o.user,void(t.parent={getTpl:e.getFile.html(i(n.OP)),isMe:!0,viewPath:n.OP||"index"})):e.location.search({}).path("/")}]),jsGen.controller("indexCtrl",["app","$scope","$routeParams","getList",function(e,t,n,i){function o(){var i=e.location.path().slice(1).split("/");n.TAG||/^T[0-9A-Za-z]{3,}$/.test(i[0])?(l=e.restAPI.tag,t.other._id=i[0],t.other.title=n.TAG||i[0],t.parent.viewPath=""):(l=e.restAPI.article,t.parent.viewPath=i[0]||"latest"),a=n.TAG||i[0]||"latest"}function r(){var i={ID:a,p:n.p,s:n.s||c.pageSize(null,"index",10)};e.promiseGet(i,l,e.param(i),e.cache.list).then(function(n){var i=n.pagination||{};n.tag&&(t.other.title=n.tag.tag,t.other._id=n.tag._id),i.path=e.location.path(),i.pageSize=c.pageSize(i.pageSize,"index"),t.pagination=i,t.articleList=n.data})}var a="",l=e.restAPI.article,c=e.myConf,s=e.rootScope.global;s.title2=s.description,t.parent={getTpl:e.getFile.html("index-article.html"),viewPath:"latest",sumModel:c.sumModel(null,"index",!1)},t.other={},t.pagination={},t.setListModel=function(){var n=t.parent;n.sumModel=c.sumModel(!n.sumModel,"index"),c.pageSize(n.sumModel?20:10,"index"),e.location.search({})},o(),r()}]),jsGen.controller("tagCtrl",["app","$scope","$routeParams","getList",function(e,t,n,i){var o=e.restAPI.tag,r=e.myConf,a={p:n.p,s:n.s||r.pageSize(null,"tag",50)};e.rootScope.global.title2=e.locale.TAG.title,t.parent={getTpl:e.getFile.html("index-tag.html")},t.pagination={},e.promiseGet(a,o,e.param(a),e.cache.list).then(function(n){var i=n.pagination||{};i.path=e.location.path(),i.pageSize=r.pageSize(i.pageSize,"tag"),i.sizePerPage=[50,100,200],t.pagination=i,t.tagList=n.data}),i("comment").then(function(n){n=e.union(n.data),e.each(n,function(t,n){t.content=e.filter("cutText")(t.content,180)}),t.hotComments=n.slice(0,6)})}]),jsGen.controller("userArticleCtrl",["app","$scope","$routeParams",function(e,t,n){function i(){var i={ID:n.ID&&"U"+n.ID||n.OP,OP:n.OP||(n.ID?"article":"index"),p:n.p,s:n.s||r.pageSize(null,"home",20)};e.promiseGet(i,o,e.param(i),e.cache.list).then(function(o){var c=0,s=o.pagination||{};if(s.path=e.location.path(),s.pageSize=r.pageSize(s.pageSize,"home"),t.pagination=s,n.ID)t.parent.title=o.user.name+a.USER[i.OP],t.user=o.user;else{var u=l.user||{};e.each(o.data,function(e){o.readtimestamp>0&&(e.read=e.updateTime<o.readtimestamp,c+=!e.read),e.isAuthor=e.author._id===u._id}),t.parent.title="index"!==i.OP?a.HOME[i.OP]:c+a.HOME.index+e.filter("date")(o.readtimestamp,"medium")|""}t.articleList=o.data})}var o=e.restAPI.user,r=e.myConf,a=e.locale,l=e.rootScope.global;t.parent={sumModel:r.sumModel(null,"index",!1),title:""},t.pagination={},t.removeArticle=null,t.removeArticleModal={confirmBtn:a.BTN_TEXT.confirm,confirmFn:function(){var n=t.removeArticle;return e.restAPI.article.remove({ID:n._id},function(){e.findItem(t.articleList,function(t,i,o){return t._id===n._id?(o.splice(i,1),e.toast.success(a.ARTICLE.removed+n.title,a.RESPONSE.success),!0):void 0}),t.removeArticle=null}),!0},cancelBtn:a.BTN_TEXT.cancel,cancelFn:function(){return t.removeArticle=null,!0}},t.setListModel=function(){var n=t.parent;n.sumModel=r.sumModel(!n.sumModel,"home"),r.pageSize(n.sumModel?20:10,"home"),e.location.search({})},t.remove=function(e){(e.isAuthor||l.isEditor)&&(t.removeArticle=e,t.removeArticleModal.modal(!0))},i()}]),jsGen.controller("userCtrl",["app","$scope","$routeParams","getUser",function(e,t,n,i){function o(){switch(n.OP){case"fans":return"user-list.html";case"article":return"user-article.html";default:return"user-article.html"}}e.rootScope.global.title2=e.locale.USER.title,t.parent={getTpl:e.getFile.html(o()),isMe:!1,viewPath:n.OP||"index"},i("U"+n.ID).then(function(n){t.user=n.data,e.rootScope.global.title2=t.user.name+e.locale.USER.title})}]),jsGen.controller("userEditCtrl",["app","$scope",function(e,t){function n(){i=e.union(a.user),e.each(i.tagsList,function(e,t,n){n[t]=e.tag}),i=e.intersect(e.union(c),i),t.user=e.union(i),e.checkDirty(c,i,t.user)}var i={},o=e.locale,r=e.filter,a=e.rootScope.global,l=r("length"),c={avatar:"",name:"",sex:"",email:"",qq:"",descp:"",passwd:"",tagsList:[""]};t.sexArray=["male","female"],t.checkName=function(e,t){return!0},t.checkMin=function(e,t){return l(t.$value)>=5},t.checkMax=function(e,t){return l(t.$value)<=15},t.checkDesc=function(e,t){return l(t.$value)<=a.SummaryMaxLen},t.checkTag=function(e,t){var n=t.$value||"";return n=angular.isString(n)?n.split(/[,，、]/):n,n.length<=a.UserTagsMax},t.checkPwd=function(e,n){var i=n.$value||"";return i===(t.user.passwd||"")},t.getTag=function(e){var n=t.user.tagsList;n.indexOf(e.tag)<0&&n.length<a.UserTagsMax&&(t.user.tagsList=n.concat(e.tag))},t.reset=function(){t.user=e.union(i)},t.verifyEmail=function(){e.restAPI.user.save({ID:"reset"},{request:"role"},function(){e.toast.success(o.RESET.email,o.RESPONSE.success)})},t.submit=function(){var r=e.union(t.user);e.validate(t)&&(r=e.checkDirty(c,i,r),e.isEmpty(r)?e.toast.info(o.USER.noUpdate):(r.passwd&&(r.passwd=e.CryptoJS.SHA256(r.passwd).toString()),e.isEmpty(r)?n():e.restAPI.user.save({},r,function(t){e.union(a.user,t.data),n(),e.toast.success(o.USER.updated,o.RESPONSE.success)})))},t.$watchCollection("user",function(t){e.checkDirty(c,i,t)}),n()}]),jsGen.controller("userListCtrl",["app","$scope","$routeParams",function(e,t,n){var i=e.restAPI.user,o=e.myConf,r=e.locale,a={ID:n.ID&&"U"+n.ID||n.OP,OP:n.OP||"fans",p:n.p,s:n.s||o.pageSize(null,"user",20)};t.parent={title:""},e.promiseGet(a,i,e.param(a),e.cache.list).then(function(i){var l=i.pagination||{};l.path=e.location.path(),l.pageSize=o.pageSize(l.pageSize,"user"),t.pagination=l,e.each(i.data,function(t){e.checkFollow(t)}),n.ID?t.parent.title=i.user.name+r.USER[a.OP]:t.parent.title=r.HOME[a.OP],t.userList=i.data})}]),jsGen.controller("userLoginCtrl",["app","$scope","$routeParams",function(e,t,n){e.clearUser(),e.rootScope.global.title2=e.locale.USER.login,t.login={logauto:!0,logname:"",logpwd:""},t.reset={title:"",type:""},t.submit=function(){if(e.validate(t)){var i=e.union(t.login);i.logtime=Date.now()-e.timeOffset,i.p=i.logpwd,i.logpwd=e.CryptoJS.SHA256(i.logpwd).toString(),e.restAPI.user.save({ID:"login"},i,function(i){e.rootScope.global.user=i.data,e.checkUser(),t.$destroy(),e.location.search({}).path(n.url||"/home")},function(n){t.reset.type=n.error.name,t.reset.title=e.locale.RESET[n.error.name]})}}}]),jsGen.controller("userRegisterCtrl",["app","$scope",function(e,t){var n=e.filter,i=n("length"),o=e.rootScope.global;e.clearUser(),o.title2=e.locale.USER.register,t.user={name:"",email:"",passwd:"",passwd2:""},t.checkName=function(e,t){return n("checkName")(t.$value)},t.checkMin=function(e,t){return i(t.$value)>=1},t.checkMax=function(e,t){return i(t.$value)<=15},t.submit=function(){var n=t.user;if(e.validate(t)){var i={name:n.name};i.passwd=e.CryptoJS.SHA256(n.passwd).toString(),e.restAPI.user.save({ID:"register"},i,function(n){e.rootScope.global.user=n.data,e.checkUser(),t.$destroy(),e.location.path("/home")})}}}]),jsGen.controller("userResetCtrl",["app","$scope","$routeParams",function(e,t,n){function i(){t.timingModal.modal(!0),o=e.timing(function(e,n){t.parent.timing=n-e},1e3,t.parent.timing),o.then(function(){t.timingModal.modal(!1),e.location.search({}).path("/")})}var o,r=e.locale;e.rootScope.global.title2=r.USER.reset,t.reset={name:"",email:"",request:n.req},t.parent={title:r.RESET[n.type],timing:5},t.timingModal={confirmBtn:r.BTN_TEXT.goBack,confirmFn:function(){return e.timing.cancel(o),e.timing(null,100,1).then(function(){e.location.search({}).path("/")}),!0},cancelBtn:r.BTN_TEXT.cancel,cancelFn:function(){return e.timing.cancel(o)}},t.submit=function(){e.validate(t)&&e.restAPI.user.save({ID:"reset"},t.reset,function(t){e.toast.success(r.RESET.email,r.RESPONSE.success),i()})},["locked","passwd"].indexOf(n.type)<0&&e.restAPI.user.get({ID:"reset",OP:n.req},function(){e.toast.success(3+r.TIMING.goHome,r.RESPONSE.success),e.timing(null,1e3,3).then(function(){e.location.search({}).path("/home")})},i)}]),jsGen.controller("userSkinCtrl",["app","$scope","FileUploader","applyFn",function(e,t,n,i){var o=e.restAPI.skin,r=e.rootScope.global,a=r.user.playerId,l=t.info={inputSkin:r.user.playerSkin||"",skin:{},cloak:{}};if(t.parent={title:"我的皮肤"},!r.user.playerId)return void e.toast.error("未绑定游戏id!");var c=(t.skinNameModal={confirmBtn:"确定",cancelBtn:"取消",confirmFn:function(){return o.save({ID:a,OP:"playerSkin"},{name:l.inputSkin},function(t){r.user.playerSkin=l.inputSkin,e.toast.success("更改成功!")}),!0},cancelFn:function(){return!0}},t.deleteModal={confirmBtn:"确定",cancelBtn:"取消",confirmFn:function(){return o.remove({ID:a,OP:t.deleteSkin.type},function(n){t.info[t.deleteSkin.type]={},e.toast.success("删除成功")}),!0},cancelFn:function(){return!0}});t.deleteSkin=function(){t.deleteSkin=t.info.skin,c.modal(!0)},t.deleteCloak=function(){t.deleteSkin=t.info.cloak,c.modal(!0)},t.upload=function(e){d=e,angular.element(".upload-input").click()},t.save=function(n){o.save({ID:a,OP:n},{md5:t.info[n].change},function(i){t.info[n].change=!1,e.toast.success("皮肤更改成功!")})};var s=r.cloudDomian||r.url||window.location.origin,u=t.uploader=new n({url:"/api/upload"});u.filters.push({name:"imageFilter",fn:function(t,n){var i="|"+t.type.slice(t.type.lastIndexOf("/")+1)+"|",o=-1!=="|png|".indexOf(i);return o||e.toast.warning("只能上传PNG文件!!!!"),o}});var d;u.onAfterAddingFile=function(e){e.upload()},t.loading=!1,u.onBeforeUploadItem=function(e){t.loading=!0,t.info[d]=t.info[d]||{},t.info[d].upload=e},u.onCompleteItem=function(n,i,o,r){var a=e.union(n.file,i);a&&a.url&&(a.url=s+a.url,t.info[d].url=a.url,t.info[d].change=a.md5),t.loading=!1},u.onErrorItem=function(t,n,i,o){e.toast.warning(n.message,n.code)},o.get({ID:a,OP:"index"},function(n){e.union(t.info,n.data)},function(t){e.toast.error(t)})}]);